<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Películas</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-4">
    <h2 class="mb-4">Lista de Películas</h2>

    <object type="text/html" data="components/tabla.html" width="100%" height="500px"></object>

    <object type="text/html" data="components/modal_pelicula.html" width="100%" height="500px"></object>


</div>





<script>
    const data = [];

    const tableBody = document.querySelector("#dataTable tbody");

    // Llamamos a la función que obtiene los datos
    getPeliculas();

    function getPeliculas() {
        data.splice(0, data.length);
        fetch("https://movie.azurewebsites.net/api/cartelera?title=&ubication=")
            .then(response => response.json())
            .then(peliculas => {
                peliculas.forEach(pelicula => {
                    data.push({
                        imdbID: pelicula.imdbID,
                        title: pelicula.title,
                        year: pelicula.Year,
                        description: pelicula.description
                    });
                });
                renderTable(); // Renderizamos la tabla
            })
            .catch(error => {
                console.error('Error al obtener las películas:', error);
            });
    }

    function renderTable() {
        // Limpiamos la tabla antes de agregar los datos
        tableBody.innerHTML = "";

        // Iteramos sobre los datos para crear filas en la tabla
        data.forEach(pelicula => {
            const row = document.createElement("tr");

            const idCell = document.createElement("td");
            idCell.textContent = pelicula.imdbID;
            row.appendChild(idCell);

            const titleCell = document.createElement("td");
            titleCell.textContent = pelicula.title;
            row.appendChild(titleCell);

            const yearCell = document.createElement("td");
            yearCell.textContent = pelicula.year;
            row.appendChild(yearCell);

            const descriptionCell = document.createElement("td");
            descriptionCell.textContent = pelicula.description;
            row.appendChild(descriptionCell);

            const actionsCell = document.createElement("td");
            const editButton = document.createElement("button");
            editButton.textContent = "Editar";
            editButton.className = "btn btn-primary btn-sm me-2";
            editButton.onclick = () => {
                openEditModal(pelicula);
            };
            actionsCell.appendChild(editButton);

            const deleteButton = document.createElement("button");
            deleteButton.textContent = "Eliminar";
            deleteButton.className = "btn btn-danger btn-sm";
            deleteButton.onclick = () => {

                eliminarPelicula(pelicula.imdbID);

            };
            actionsCell.appendChild(deleteButton);

            row.appendChild(actionsCell);

            // Añadimos la fila a la tabla
            tableBody.appendChild(row);
        });

    }
    function eliminarPelicula(id){
        fetch("https://movie.azurewebsites.net/api/cartelera?imdbID="+id, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                alert(data.message)
                getPeliculas();
            })
            .catch(error => {
                alert(error.message)
            });
    }
    function openEditModal(pelicula) {
        // Asignar los valores de la película al formulario del modal
        document.getElementById('movieId').value = pelicula.imdbID;
        document.getElementById('movieTitle').value = pelicula.title;
        document.getElementById('movieYear').value = pelicula.year;
        document.getElementById('movieType').value = pelicula.type;
        document.getElementById('moviePoster').value = pelicula.poster;
        document.getElementById('movieEstado').value = pelicula.estado ? "true" : "false";
        document.getElementById('movieDescription').value = pelicula.description;
        document.getElementById('movieUbication').value = pelicula.ubication;

        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();

    }

    function ActualizarPelicula(){
        console.log("Actualizar Pelicula")
        const pelicula = {
            imdbID: document.getElementById('movieId').value,
            title: document.getElementById('movieTitle').value,
            Year: document.getElementById('movieYear').value,
            type: document.getElementById('movieType').value,
            poster: document.getElementById('moviePoster').value,
            estado: document.getElementById('movieEstado').value === "true",
            description: document.getElementById('movieDescription').value,
            ubication: document.getElementById('movieUbication').value
        };
        console.log(data)
        fetch("https://movie.azurewebsites.net/api/cartelera?imdbID="+pelicula.imdbID , {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(pelicula)
        })
            .then(response => response.json())
            .then(data => {
                alert(data)
                getPeliculas();
            })
            .catch(error => {
                alert(error)
            });

        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.hide();

    }

</script>

<!-- Incluir Bootstrap JS (opcional para interactividad) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
